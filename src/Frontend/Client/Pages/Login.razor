@page "/login"
@inject ApiClient Api
@inject SavAuthStateProvider AuthProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudPaper Class="mx-auto pa-6" MaxWidth="400">
    <MudText Typo="Typo.h5" Class="mb-4">Welcome back</MudText>
    <MudForm @ref="_form">
        <MudTextField @bind-Value="_model.Email" Label="Email" Required="true" Immediate="true" />
        <MudTextField @bind-Value="_model.Password" Label="Password" InputType="InputType.Password" Required="true" Immediate="true" />
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Disabled="_loading" OnClick="OnLogin">Login</MudButton>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Class="mt-4" OnClick="() => Navigation.NavigateTo('/register')">Register</MudButton>
    </MudForm>
</MudPaper>

@code {
    private readonly LoginRequest _model = new(string.Empty, string.Empty);
    private MudForm? _form;
    private bool _loading;

    private async Task OnLogin()
    {
        if (_form is null)
        {
            return;
        }

        await _form.Validate();
        if (!_form.IsValid)
        {
            Snackbar.Add("Please fill in all required fields.", Severity.Warning);
            return;
        }

        _loading = true;
        try
        {
            var auth = await Api.LoginAsync(_model);
            await AuthProvider.SetTokenAsync(auth.AccessToken);
            Snackbar.Add("Logged in successfully.", Severity.Success);
            Navigation.NavigateTo("/");
        }
        catch
        {
            Snackbar.Add("Login failed. Check credentials.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}
